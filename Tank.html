<!DOCTYPE html>
<html>

<head>
    <title>俄罗斯方块游戏</title>
    <meta name="viewport"
        content="width=device-width,initial-scale=0.3,minimum-scale=0.3,maximum-scale=0.3,user-scalable=no" />
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            background-color: #f2f2f2;
        }

        #game-board {
            width: 1200px;
            margin-left: auto;
            margin-right: auto;
            height: 900px;
            border: 1px solid #ccc;
            background-color: #fff;
            position: relative;
        }

        .block {
            width: 28px;
            height: 28px;
            border: 1px;
            position: absolute;
            background-color: #000;
        }

        .ControlButton {
            width: 1200px;
            margin-top: 80px;
            margin-left: auto;
            margin-right: auto;
        }

        .ControlButton .LeftControl {
            width: 690px;
            float: left;
            margin-left: 100px;
        }

        .ControlButton .LeftControl .control_btn {
            display: block;
            width: 150px;
            height: 150px;
            border-radius: 75px;
            background-color: blue;
            -moz-border-radius: 75px;
            /* 老的 Firefox */
            -webkit-border-radius: 75px;
        }

        .ControlButton .LeftControl .Top_btn {
            padding-left: 210px;
        }

        .ControlButton .LeftControl .Left_btn {
            float: left;
            padding-left: 30px;
        }

        .ControlButton .LeftControl .Right_btn {
            float: left;
            padding-left: 210px;
        }

        .ControlButton .LeftControl .Bottom_btn {
            padding-left: 210px;
            clear: both;
        }

        .RightControl {
            width: 240px;
            float: right;
            padding-top: 100px;
            margin-right: 100px;
        }

        .RightControl .Change_btn {
            display: block;
            width: 240px;
            height: 240px;
            border-radius: 120px;
            background-color: blue;
            -moz-border-radius: 120px;
            /* 老的 Firefox */
            -webkit-border-radius: 120px;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>

<body>
    <div id="game-board"></div>
    <div style="clear: both;"></div>
    <div class="ControlButton" style="display: none;">
        <div class="LeftControl">
            <div class="Top_btn">
                <a class="control_btn" id="Top_btn"></a>
            </div>
            <div class="Left_btn">
                <a class="control_btn" id="Left_btn"></a>
            </div>
            <div class="Right_btn">
                <a class="control_btn" id="Right_btn"></a>
            </div>
            <div class="Bottom_btn">
                <a class="control_btn" id="Bottom_btn"></a>
            </div>
        </div>
        <div class="RightControl">
            <a class="Change_btn" id="Change_btn"></a>
        </div>
        <div style="clear:both"></div>
    </div>
</body>
<script>
    const gameBoard = document.getElementById('game-board');
    const blockSize = 30;
    const rows = 30;
    const columns = 40;
    let board = [];
    const MaxEnemy = 8;
    let Tanks = [];
    let Fires = [];
    let MyTank = {};
    let Bricks = [];
    let Eagle = {};
    const AllEnemy = 30;
    let HasEnemy = 0;
    let DisEnemy = 0;
    const Hero_Speed = 100;  //英雄速度，越大越慢
    const Level_Speed = 500; //普通敌人速度，越大越慢
    const Spuer_Speed = 100; //装甲车敌人速度，越大越慢
    const Fire_Speed = 50;  //普通炮弹速度，越大越慢
    const BigFire_Speed = 25;  //榴弹炮弹速度，越大越慢
    const Fire_Rate = 30;    //敌人开火几率（0~100%）
    let lafe = 3;//生命
    let iceStep = 4;//冰块惯性
    const intTimeFunctions = [];//定时任务事件
    createBoard();
    startGame();

    // 创建游戏面板
    function createBoard() {
        for (let row = 0; row < rows; row++) {
            board[row] = [];
            for (let col = 0; col < columns; col++) {
                const block = document.createElement('div');
                block.className = 'block';
                block.style.top = row * blockSize + 'px';
                block.style.left = col * blockSize + 'px';
                block.id = 'board' + row + '_' + col;
                gameBoard.appendChild(block);
                board[row][col] = block;
            }
        }
    }

    // 游戏逻辑
    function startGame() {
        //初始化变量
        lafe = 3;
        HasEnemy = 0;
        board = [];
        Tanks = [];
        Fires = [];
        MyTank = {};
        Bricks = [];
        Eagle = {};
        //清空定时事件
        ClearAllintTimeFunctions();
        //英雄登场
        initHero();
        //初始化鹰巢
        initEagle();
        //初始化砖头
        initBrick();
        //敌人登场
        SetintTimeFunctions("intmakeEnemy", setInterval('makeEnemy()', Level_Speed));
        //普通敌人移动
        SetintTimeFunctions("intNormalEnemyMove", setInterval('NormalEnemyMove()', Level_Speed));
        //装甲车敌人移动
        SetintTimeFunctions("intSuperEnemyMove", setInterval('SuperEnemyMove()', Spuer_Speed));
        //普通炮弹监控
        SetintTimeFunctions("intcheckNomailFireAll", setInterval('checkNomailFireAll()', Fire_Speed));
        //榴弹炮弹监控
        SetintTimeFunctions("intcheckSuperFireAll", setInterval('checkSuperFireAll()', BigFire_Speed));
        //渲染屏幕
        SetintTimeFunctions("intflashBoard", setInterval('flashBoard()', 50));
    }
    //英雄登场
    function initHero() {
        if (!MyTank) { MyTank = {} };
        MyTank.point = [rows - 2, Math.ceil(columns / 2) - 8];
        MyTank.direction = "top";
        MyTank.Role = 0;
        MyTank.InIce = 0;  //是否在冰块中
        MyTank.INTStep = 1;   //用于记录冰块惯性
        MyTank.blood = 0;
        MyTank.TankType = "PT";
        MyTank.id = guid();
        MyTank.TankBody = GetTankBody(MyTank.point);
        MyTank.TankImg = GetTankImg(MyTank.point, MyTank.direction, MyTank.Role, MyTank.TankType, MyTank.blood);
        Tanks.push(MyTank);
    }
    //初始化鹰巢
    function initEagle() {
        Eagle.colour = "blue";
        Eagle.EagleBody = [[rows - 1, Math.ceil(columns / 2) - 1], [rows - 1, Math.ceil(columns / 2)], [rows - 2, Math.ceil(columns / 2) - 1], [rows - 2, Math.ceil(columns / 2)]];
    }

    //初始化砖头
    function initBrick() {
        ///普通砖块
        var arrayPoints = [];
        for (var i = 15; i < 20; i++) {
            for (var j = 0; j < 4; j++) {
                arrayPoints.push([i, j]);
            }
        }
        for (var i = 15; i < 18; i++) {
            for (var j = 4; j < 15; j++) {
                arrayPoints.push([i, j]);
            }
        }
        for (var i = 12; i < 15; i++) {
            for (var j = 3; j < 10; j++) {
                arrayPoints.push([i, j]);
            }
        }
        for (var i = 24; i < 30; i++) {
            for (var j = 30; j < 34; j++) {
                arrayPoints.push([i, j]);
            }
        }
        for (var i = 3; i < 5; i++) {
            for (var j = 21; j < 40; j++) {
                arrayPoints.push([i, j]);
            }
        }
        for (var i = 10; i < 12; i++) {
            for (var j = 3; j < 10; j++) {
                arrayPoints.push([i, j]);
            }
        }
        for (var i = 5; i < 10; i++) {
            for (var j = 6; j < 10; j++) {
                arrayPoints.push([i, j]);
            }
        }
        for (var i = 10; i < 20; i++) {
            for (var j = 37; j < 40; j++) {
                arrayPoints.push([i, j]);
            }
        }
        for (var i = 23; i < 24; i++) {
            for (var j = 16; j < 19; j++) {
                arrayPoints.push([i, j]);
            }
        }
        ///鹰巢砖块
        arrayPoints = arrayPoints.concat([
            [rows - 1, Math.ceil(columns / 2) - 2], [rows - 1, Math.ceil(columns / 2) - 3],
            [rows - 1, Math.ceil(columns / 2) + 1], [rows - 1, Math.ceil(columns / 2) + 2],
            [rows - 2, Math.ceil(columns / 2) - 2], [rows - 2, Math.ceil(columns / 2) - 3],
            [rows - 2, Math.ceil(columns / 2) + 1], [rows - 2, Math.ceil(columns / 2) + 2],
            [rows - 3, Math.ceil(columns / 2) - 2], [rows - 3, Math.ceil(columns / 2) - 3],
            [rows - 3, Math.ceil(columns / 2) + 1], [rows - 3, Math.ceil(columns / 2) + 2],
            [rows - 3, Math.ceil(columns / 2) - 1], [rows - 3, Math.ceil(columns / 2)],
            [rows - 4, Math.ceil(columns / 2) - 2], [rows - 4, Math.ceil(columns / 2) - 3],
            [rows - 4, Math.ceil(columns / 2) + 1], [rows - 4, Math.ceil(columns / 2) + 2],
            [rows - 4, Math.ceil(columns / 2) - 1], [rows - 4, Math.ceil(columns / 2)]
        ]);
        var GBPoints = [[15, 17], [15, 18], [15, 19], [15, 20], [15, 21], [15, 22], [16, 17], [16, 18], [16, 19], [16, 20], [16, 21], [16, 22]];
        GBPoints = GBPoints.concat([
            [5, 0], [5, 1], [5, 2], [5, 3], [5, 4], [5, 5], [6, 0], [6, 1], [6, 2], [6, 3], [6, 4], [6, 5]
        ]);
        GBPoints = GBPoints.concat([
            [5, 34], [5, 35], [5, 36], [5, 37], [5, 38], [5, 39], [6, 34], [6, 35], [6, 36], [6, 37], [6, 38], [6, 39]
        ]);
        GBPoints = GBPoints.concat([
            [18, 7], [18, 8], [18, 9], [18, 10], [18, 11], [19, 7], [20, 7], [21, 7]
        ]);
        GBPoints = GBPoints.concat([
            [18, 32], [18, 31], [18, 30], [18, 29], [18, 28], [19, 32], [20, 32], [21, 32]
        ]);
        var CDPoints = [[18, 15], [18, 16], [18, 14], [18, 13], [18, 12], [18, 17], [18, 18], [18, 19], [18, 20], [18, 21], [18, 22]];
        for (var i = 22; i < 26; i++) {
            for (var j = 8; j < 13; j++) {
                CDPoints.push([i, j]);
            }
        }
        for (var i = 19; i < 22; i++) {
            for (var j = 8; j < 32; j++) {
                CDPoints.push([i, j]);
            }
        }
        for (var i = 12; i < 22; i++) {
            for (var j = 23; j < 27; j++) {
                CDPoints.push([i, j]);
            }
        }
        var HLPoints = [];
        for (var i = 12; i < 14; i++) {
            for (var j = 10; j < 20; j++) {
                HLPoints.push([i, j]);
            }
        }
        for (var i = 6; i < 8; i++) {
            for (var j = 20; j < 22; j++) {
                HLPoints.push([i, j]);
            }
        }
        for (var i = 6; i < 8; i++) {
            for (var j = 22; j < 29; j++) {
                HLPoints.push([i, j]);
            }
        }
        var BKPoints = [];
        for (var i = 8; i < 17; i++) {
            for (var j = 27; j < 32; j++) {
                BKPoints.push([i, j]);
            }
        }
        for (var i = 8; i < 12; i++) {
            for (var j = 10; j < 27; j++) {
                BKPoints.push([i, j]);
            }
        }
        for (var i = 4; i < 8; i++) {
            for (var j = 10; j < 20; j++) {
                BKPoints.push([i, j]);
            }
        }
        for (var i = 10; i < 17; i++) {
            for (var j = 32; j < 37; j++) {
                BKPoints.push([i, j]);
            }
        }
        for (var i = 17; i < 22; i++) {
            for (var j = 33; j < 37; j++) {
                BKPoints.push([i, j]);
            }
        }
        MakeBrick(arrayPoints, "ZT");
        MakeBrick(GBPoints, "GB");
        MakeBrick(CDPoints, "CD");
        MakeBrick(HLPoints, "HL");
        MakeBrick(BKPoints, "BK");
    }

    ///刷新游戏界面线程
    function flashBoard() {
        var blocks = document.querySelectorAll('.block');
        for (let block of blocks) {
            block.style.backgroundColor = "#000";
        }
        //构建草地以外的方块
        var otherBricks = Bricks.filter(i => { return i.BirckType != "CD" });
        for (let unit of otherBricks) {
            var block = document.getElementById('board' + unit.point[0] + '_' + unit.point[1]);
            block.style.backgroundColor = unit.colour;
        }
        for (let Tank of Tanks) {
            for (let unit of Tank.TankImg.CloArray) {
                var block = document.getElementById('board' + unit[0] + '_' + unit[1]);
                if (Tank.point[0] == unit[0] && Tank.point[1] == unit[1]) {
                    if (Tank.TankType == "LDP" || Tank.TankType == "ZJC") {
                        block.style.backgroundColor = "yellow";
                    }
                    else {
                        block.style.backgroundColor = Tank.TankImg.colour;
                    }
                }
                else {
                    block.style.backgroundColor = Tank.TankImg.colour;
                }
            }
        }
        //构建炮弹
        for (let unit of Fires) {
            var block = document.getElementById('board' + unit.point[0] + '_' + unit.point[1]);
            block.style.backgroundColor = unit.colour;
        }
        //构建鹰巢
        for (let unit of Eagle.EagleBody) {
            var block = document.getElementById('board' + unit[0] + '_' + unit[1]);
            block.style.backgroundColor = Eagle.colour;
        }
        //构建草地
        var CDBricks = Bricks.filter(i => { return i.BirckType == "CD" });
        for (let unit of CDBricks) {
            var block = document.getElementById('board' + unit.point[0] + '_' + unit.point[1]);
            if (block.style.backgroundColor != "rgb(0, 0, 0)" && block.style.backgroundColor != "rgb(94, 255, 1)")//隐藏
            {
                block.style.backgroundColor = "rgb(94, 225, 1)";
            }
            else {
                block.style.backgroundColor = unit.colour;
            }
        }
    }

    //装甲车敌人移动
    function SuperEnemyMove() {
        var EnemyTanks = Tanks.filter(i => { return i.Role == 1 && i.TankType == "ZJC" });
        for (var unit of EnemyTanks) {
            TankMove(unit);
            var rate = Math.floor(Math.random() * 100);
            if (rate > 100 - Fire_Rate) {
                TankFire(unit);
            }
        }
    }
    //普通敌人移动
    function NormalEnemyMove() {
        var EnemyTanks = Tanks.filter(i => { return i.Role == 1 && i.TankType != "ZJC" });
        for (var unit of EnemyTanks) {
            TankMove(unit);
            var rate = Math.floor(Math.random() * 100);
            if (rate > 100 - Fire_Rate) {
                TankFire(unit);
            }
        }
    }

    //普通炮弹监控
    function checkNomailFireAll() {
        var NormalFires = Fires.filter(i => { return i.SpeedType == 0 });
        for (var unit of NormalFires) {
            FireMove(unit);
        }
    }

    //榴弹炮弹监控
    function checkSuperFireAll() {
        var LDPFires = Fires.filter(i => { return i.SpeedType == 1 });
        for (var unit of LDPFires) {
            FireMove(unit);
        }
    }
    //坦克图像坐标
    function GetTankImg(Point, direction, Role, TankType, blood) {
        let colour = Role ? "red" : "pink";
        if (TankType == "ZT") {
            if (blood === 3) {
                colour = "yellow";
            }
            if (blood === 2) {
                colour = "#FFD700";
            }
            else if (blood === 1) {
                colour = "orange";
            }
        }
        let CloArray = [];
        if (direction == "top") {
            CloArray = [[Point[0] - 1, Point[1]],
            [Point[0], Point[1] - 1], [Point[0], Point[1]], [Point[0], Point[1] + 1],
            [Point[0] + 1, Point[1] - 1], [Point[0] + 1, Point[1] + 1]];
            if (TankType == "ZT" || TankType == "LDP") {
                CloArray.push([Point[0] + 1, Point[1]]);
            }
        }
        else if (direction == "right") {
            CloArray = [[Point[0] - 1, Point[1] - 1], [Point[0] - 1, Point[1]],
            [Point[0], Point[1]], [Point[0], Point[1] + 1],
            [Point[0] + 1, Point[1] - 1], [Point[0] + 1, Point[1]]];
            if (TankType == "ZT" || TankType == "LDP") {
                CloArray.push([Point[0], Point[1] - 1]);
            }
        }
        else if (direction == "left") {
            CloArray = [[Point[0] - 1, Point[1]], [Point[0] - 1, Point[1] + 1],
            [Point[0], Point[1] - 1], [Point[0], Point[1]],
            [Point[0] + 1, Point[1]], [Point[0] + 1, Point[1] + 1]];
            if (TankType == "ZT" || TankType == "LDP") {
                CloArray.push([Point[0], Point[1] + 1]);
            }
        }
        else if (direction == "bottom") {
            CloArray = [[Point[0] - 1, Point[1] - 1], [Point[0] - 1, Point[1] + 1],
            [Point[0], Point[1] - 1], [Point[0], Point[1]], [Point[0], Point[1] + 1],
            [Point[0] + 1, Point[1]]];
            if (TankType == "ZT" || TankType == "LDP") {
                CloArray.push([Point[0] - 1, Point[1]]);
            }
        }
        return { colour: colour, CloArray: CloArray };
    }

    //创建敌人线程
    function makeEnemy() {
        if (HasEnemy < AllEnemy && Tanks.filter(i => { return i.Role == 1 }).length < MaxEnemy) {
            const PointArray = [[1, 1], [1, Math.ceil(columns / 2)], [1, columns - 1]];//初始点位置
            let Point = PointArray[Math.floor(Math.random() * PointArray.length)];
            var direction = getRandomDir();
            var TankType = getTankType();
            var TankBody = GetTankBody(Point);
            var Role = 1;
            var blood = TankType == "ZT" ? 3 : 0;
            var tankid = guid();
            if (CheckExist(TankBody, tankid)) {
                Tanks.push({
                    id: tankid,
                    point: Point,
                    direction: direction,
                    Role: Role,
                    TankBody: TankBody,
                    TankType: TankType,
                    blood: blood,
                    TankImg: GetTankImg(Point, direction, Role, TankType, blood)
                });
                HasEnemy = HasEnemy + 1;
            }
        }
    }
    function GetTankBody(Point) {
        return [[Point[0] - 1, Point[1] - 1], [Point[0] - 1, Point[1]], [Point[0] - 1, Point[1] + 1],
        [Point[0], Point[1] - 1], [Point[0], Point[1]], [Point[0], Point[1] + 1],
        [Point[0] + 1, Point[1] - 1], [Point[0] + 1, Point[1]], [Point[0] + 1, Point[1] + 1]];
    }

    ///判断是否有障碍物
    function CheckExist(TankBody, tankid) {
        let result = 1;
        for (let unit of TankBody) {
            //检查坦克
            var otherTanks = Tanks.filter(i => { return i.id !== tankid });
            if (otherTanks.length) {
                for (let Tank of otherTanks) {
                    if (Tank.TankBody.filter(i => { return i[0] == unit[0] && i[1] == unit[1] }).length) {
                        return 0;
                    }
                }
            }
            //检查鹰巢
            if (Eagle.EagleBody.filter(i => { i[0] == unit[0] && i[1] == unit[1] }).length) {
                return 0;
            }
            //检查边界
            if (unit[0] > (rows - 1) || unit[1] > (columns - 1) || unit[0] < 0 || unit[1] < 0) {
                return 0;
            }
            //检查墙体
            if (Bricks.filter(i => i.point[0] == unit[0] && i.point[1] == unit[1] && i.BirckType != "CD" && i.BirckType != "BK").length) {
                return 0;
            }
            //冰块特殊处理
            else if (Bricks.filter(i => i.point[0] == unit[0] && i.point[1] == unit[1] && i.BirckType === "BK").length) {
                result = 2;
            }
        }
        return result;
    }
    ///坦克移动
    function TankMove(Tank, direction, ifIceStep) {
        var NestTankBody = [];
        if (!direction) {
            direction = Tank.direction;
        }
        if (Tank.Role === 1) {
            var rate = Math.floor(Math.random() * 100);
            if (rate > 70) {
                direction = getRandomDir();
            }
        }
        if (Tank.direction !== direction) {
            Tank.direction = direction;
            Tank.TankImg = GetTankImg(Tank.point, Tank.direction, Tank.Role, Tank.TankType, Tank.blood);
            return;
        }
        var NextPoint = [Tank.point[0], Tank.point[1]];
        if (Tank.direction == "left") {
            NextPoint[1] = NextPoint[1] - 1;
        }
        else if (Tank.direction == "right") {
            NextPoint[1] = NextPoint[1] + 1;
        }
        else if (Tank.direction == "top") {
            NextPoint[0] = NextPoint[0] - 1;
        }
        else if (Tank.direction == "bottom") {
            NextPoint[0] = NextPoint[0] + 1;
        }
        for (var unit of Tank.TankBody) {
            var x = unit[0];
            var y = unit[1];
            if (Tank.direction == "left") {
                y = y - 1;
            }
            else if (Tank.direction == "right") {
                y = y + 1;
            }
            else if (Tank.direction == "top") {
                x = x - 1;
            }
            else if (Tank.direction == "bottom") {
                x = x + 1;
            }
            NestTankBody.push([x, y]);
        }
        var CheckRes = CheckExist(NestTankBody, Tank.id);
        if (CheckRes) {
            Tank.TankBody = NestTankBody;
            Tank.point = NextPoint;
            Tank.TankImg = GetTankImg(Tank.point, Tank.direction, Tank.Role, Tank.TankType, Tank.blood);
        }
        if (CheckRes === 2) {
            Tank.InIce = 1; //坦克入冰块
        }
        else {
            Tank.InIce = 0; //坦克出冰块
        }
        if (ifIceStep && Tank.INTStep < iceStep && Tank) {
            Tank.INTStep = Tank.INTStep + 1; //冰块惯性
        }
        var intICEMoveGo = GetintTimeFunctions("ICEMoveGo_" + Tank.id);
        if (ifIceStep && intICEMoveGo && (Tank.INTStep >= iceStep || !Tank || CheckRes !== 2)) {
            ClearintTimeFunctions("ICEMoveGo_" + Tank.id);
        }
        return CheckRes;
    }
    ///坦克开火
    function TankFire(Tank) {
        var FirePoint = [];
        if (Tank.direction == "top") {
            FirePoint = [Tank.point[0] - 1, Tank.point[1]];
        }
        else if (Tank.direction == "right") {
            FirePoint = [Tank.point[0], Tank.point[1] + 1];
        }
        else if (Tank.direction == "left") {
            FirePoint = [Tank.point[0], Tank.point[1] - 1];
        }
        else if (Tank.direction == "bottom") {
            FirePoint = [Tank.point[0] + 1, Tank.point[1]];
        }
        if (Fires.filter(i => { return i.Tankid == Tank.id }).length >= 2) {
            return;
        }
        else {
            let SpeedType = 0;
            if (Tank.TankType == "LDP") {
                SpeedType = 1;
            }
            Fires.push({
                point: FirePoint,
                direction: Tank.direction,
                Role: Tank.Role,
                Tankid: Tank.id,
                colour: "#c6c6c6",
                id: guid(),
                FirePower: 0,
                SpeedType: SpeedType
            });
        }
    }
    ///坦克毁灭
    function TankDistory(Tank) {
        if (Tank.Role == 1) {
            var index = Tanks.findIndex(i => { return i.id === Tank.id; });
            var intICEMoveGo = GetintTimeFunctions("ICEMoveGo_" + Tank.id);
            if (intICEMoveGo) {
                ClearintTimeFunctions("ICEMoveGo_" + Tank.id);
            }
            Tanks.splice(index, 1);
            DisEnemy=DisEnemy+1;
            if(DisEnemy>=30)
            {
                alert("游戏通关");
                startGame();
            }
        }
        else if (Tank.Role == 0) {
            lafe = lafe - 1;
            var index = Tanks.findIndex(i => { return i.id === Tank.id; });
            var intICEMoveGo = GetintTimeFunctions("ICEMoveGo_" + Tank.id);
            if (intICEMoveGo) {
                ClearintTimeFunctions("ICEMoveGo_" + Tank.id);
            }
            Tanks.splice(index, 1);
            if (lafe < 0) {
                alert("游戏结束");
                startGame();
            }
            else {
                initHero();
            }
        }
    }
    ///砖块毁灭
    function BrickDistory(Brick, Fire) {
        if (Brick.BirckType == "ZT" || (Brick.BirckType == "GB" && Fire.FirePower))//只有砖头钢板可以打碎
        {
            var index = Bricks.findIndex(i => { return i.id === Brick.id; });
            Bricks.splice(index, 1);
        }
        else {
            return;
        }
        //毁掉相邻砖头
        if (Fire.direction === "top" || Fire.direction === "bottom") {
            var temp = Bricks.findIndex(i => { return i.point[0] === Brick.point[0] && i.point[1] + 1 == Brick.point[1] && (i.BirckType == "ZT" || i.BirckType == "GB" && Fire.FirePower); });
            if (temp >= 0) {
                Bricks.splice(temp, 1);
            }
            temp = Bricks.findIndex(i => { return i.point[0] === Brick.point[0] && i.point[1] - 1 == Brick.point[1] && (i.BirckType == "ZT" || i.BirckType == "GB" && Fire.FirePower); });
            if (temp >= 0) {
                Bricks.splice(temp, 1);
            }
        }
        else if (Fire.direction === "left" || Fire.direction === "right") {
            var temp = Bricks.findIndex(i => { return i.point[0] === Brick.point[0] - 1 && i.point[1] == Brick.point[1] && (i.BirckType == "ZT" || i.BirckType == "GB" && Fire.FirePower); });
            if (temp >= 0) {
                Bricks.splice(temp, 1);
            }
            temp = Bricks.findIndex(i => { return i.point[0] === Brick.point[0] + 1 && i.point[1] == Brick.point[1] && (i.BirckType == "ZT" || i.BirckType == "GB" && Fire.FirePower); });
            if (temp >= 0) {
                Bricks.splice(temp, 1);
            }
        }
    }
    ///子弹毁灭
    function FireDistory(Fire) {
        var index = Fires.findIndex(i => { return i.id === Fire.id; });
        Fires.splice(index, 1);
    }
    ///鹰巢毁灭
    function EagleDistory(Eagle) {
        var index = Tanks.findIndex(i => { return i.id === MyTank.id; });
        Tanks.splice(index, 1);
        alert("游戏结束");
        startGame();
    }
    ///炮弹移动
    function FireMove(Fire) {
        var NextPoint = [Fire.point[0], Fire.point[1]];
        if (Fire.direction == "left") {
            NextPoint[1] = NextPoint[1] - 1;
        }
        else if (Fire.direction == "right") {
            NextPoint[1] = NextPoint[1] + 1;
        }
        else if (Fire.direction == "top") {
            NextPoint[0] = NextPoint[0] - 1;
        }
        else if (Fire.direction == "bottom") {
            NextPoint[0] = NextPoint[0] + 1;
        }
        if (CheckFire(NextPoint, Fire)) {
            Fire.point = NextPoint;
        }
        else {
            FireDistory(Fire);
        }
    }
    //检查炮弹弹道，毁灭打击对象
    function CheckFire(NextPoint, Fire) {
        //检查边界
        if (NextPoint[0] > (rows - 1) || NextPoint[1] > (columns - 1) || NextPoint[0] < 0 || NextPoint[1] < 0) {
            return false;
        }
        //检查坦克,准备毁灭
        for (let Tank of Tanks) {
            for (let unit of Tank.TankImg.CloArray) {
                if (unit[0] == NextPoint[0] && unit[1] == NextPoint[1]) {
                    if (Tank.Role !== Fire.Role) {
                        if (Tank.blood > 0) {
                            Tank.blood = Tank.blood - 1;
                            Tank.TankImg = GetTankImg(Tank.point, Tank.direction, Tank.Role, Tank.TankType, Tank.blood);
                        }
                        else {
                            TankDistory(Tank);
                        }
                    }
                    return false;
                }
            }
        }
        //检查墙体,准备毁灭
        var disBrick = Bricks.find(i => { return i.point[0] === NextPoint[0] && i.point[1] === NextPoint[1] && (i.BirckType == "ZT" || i.BirckType == "GB") });
        if (disBrick) {
            BrickDistory(disBrick, Fire);
            return false;
        }
        //检查其他炮弹，准备毁灭
        var disFires = Fires.find(i => { return i.point[0] == NextPoint[0] && i.point[1] == NextPoint[1] && i.Tankid !== Fire.Tankid });
        if (disFires) {
            FireDistory(disFires);
            return false;
        }
        //检查鹰巢，准备毁灭
        for (let unit of Eagle.EagleBody) {
            if (unit[0] == NextPoint[0] && unit[1] == NextPoint[1]) {
                EagleDistory(Eagle);
                return false;
            }
        }
        return true;
    }

    function getRandomDir() {
        const dir_array = ["left", "right", "top", "bottom"];
        let dir_index = Math.floor(Math.random() * 4);
        return dir_array[dir_index];
    }
    ///随机生产坦克类型
    function getTankType() {
        const TankType = ["PT", "LDP", "ZT", "ZJC"];
        let dir_index = Math.floor(Math.random() * 4);
        return TankType[dir_index];
    }

    function guid() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = Math.random() * 16 | 0,
                v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function MakeBrick(arrayPoints, BirckType) {
        var colour = ""
        if (BirckType == "ZT")//砖头
        {
            colour = "#e6620b";
        }
        else if (BirckType == "GB")//钢板
        {
            colour = "silver";
        }
        else if (BirckType == "HL")//河流
        {
            colour = "#0CCDFD";
        }
        else if (BirckType == "CD")//草地
        {
            colour = "#5eff01";
        }
        else if (BirckType == "BK")//冰块
        {
            colour = "#dafcfd";
        }
        for (var unit of arrayPoints) {
            Bricks.push({
                id: guid(),
                point: unit,
                colour: colour,
                BirckType: BirckType
            });
        }
    }
    function GetintTimeFunctions(id) {
        var TimeFunction = intTimeFunctions.find(i => { return i.id == id; });
        return TimeFunction;
    }
    function ClearintTimeFunctions(id) {
        var TimeFunction = intTimeFunctions.find(i => { return i.id == id; });
        if (TimeFunction) {
            if (TimeFunction.value) {
                clearInterval(TimeFunction.value);
                TimeFunction.value = null;
            }
            var Intindex = intTimeFunctions.findIndex(i => { return i.id == id; });
            if (Intindex >= 0) {
                intTimeFunctions.splice(Intindex, 1);
            }
        }
    }
    function SetintTimeFunctions(id, TimeRes) {
        var TimeFunction = intTimeFunctions.find(i => { return i.id == id; });
        if (!TimeFunction) {
            intTimeFunctions.push({
                id: id,
                value: TimeRes
            });
        }
        else if (TimeFunction) {
            if (TimeFunction.value) {
                clearInterval(TimeFunction.value);
            }
            TimeFunction.value = TimeRes;
        }
    }
    function ClearAllintTimeFunctions() {
        for (unit of intTimeFunctions) {
            if (unit.value) {
                clearInterval(unit.value);
            }
        }
        intTimeFunctions.splice(0, intTimeFunctions.length);
    }
    document.addEventListener('keyup', function (event) {
        // 获取按下的键码
        var keyCode = event.keyCode || event.which;
        if (keyCode == 37 || keyCode == 38 || keyCode == 39 || keyCode == 40) {
            var intMoveGo = GetintTimeFunctions("intMoveGo");
            if (intMoveGo && intMoveGo.value) {
                var intICEMoveGo = GetintTimeFunctions("ICEMoveGo_" + MyTank.id);
                if (!intICEMoveGo && MyTank && MyTank.InIce) {
                    MyTank.INTStep = 1;
                    SetintTimeFunctions("ICEMoveGo_" + MyTank.id, setInterval(TankMove, Hero_Speed, MyTank, MyTank.direction, 1));
                }
                ClearintTimeFunctions("intMoveGo");
            }
        }
        else if (keyCode == 32) {
            var intFireGo = GetintTimeFunctions("intFireGo");
            if (intFireGo && intFireGo.value) {
                ClearintTimeFunctions("intFireGo");
            }
        }
    });
    // 监听键盘按下事件
    document.addEventListener('keydown', function (event) {
        // 获取按下的键码
        var keyCode = event.keyCode || event.which;
        var intMoveGo = GetintTimeFunctions("intMoveGo");
        var intFireGo = GetintTimeFunctions("intFireGo");
        if ((keyCode == 37 || keyCode == 38 || keyCode == 39 || keyCode == 40) && intMoveGo && intMoveGo.value) {
            return;
        }
        else if (keyCode == 32 && intFireGo && intFireGo.value) {
            return;
        }
        if (!MyTank) { return; }
        switch (keyCode) {
            case 37: //左箭头键被按下
                {
                    ClearintTimeFunctions("ICEMoveGo_" + MyTank.id);//有动力了，清除惯性
                    TankMove(Hero_Speed, MyTank, "left");
                    SetintTimeFunctions("intMoveGo", setInterval(TankMove, Hero_Speed, MyTank, "left"));
                }
                break;
            case 38: //上箭头键被按下
                {
                    ClearintTimeFunctions("ICEMoveGo_" + MyTank.id);//有动力了，清除惯性
                    TankMove(Hero_Speed, MyTank, "top");
                    SetintTimeFunctions("intMoveGo", setInterval(TankMove, Hero_Speed, MyTank, "top"));
                }
                break;
            case 39: //右箭头键被按下
                {
                    ClearintTimeFunctions("ICEMoveGo_" + MyTank.id);//有动力了，清除惯性
                    TankMove(Hero_Speed, MyTank, "right");
                    SetintTimeFunctions("intMoveGo", setInterval(TankMove, Hero_Speed, MyTank, "right"));
                }
                break;
            case 40: //下箭头键被按下
                {
                    ClearintTimeFunctions("ICEMoveGo_" + MyTank.id);//有动力了，清除惯性
                    TankMove(Hero_Speed, MyTank, "bottom");
                    SetintTimeFunctions("intMoveGo", setInterval(TankMove, Hero_Speed, MyTank, "bottom"));
                }
                break;
            case 32: //空格头键被按下
                {
                    SetintTimeFunctions("intFireGo", setInterval(TankFire, Fire_Speed, MyTank));
                }
                break;
            default:
                return;
                break;
        }
    });

    jQuery(document).ready(function () {
        $('#Top_btn').bind('touchstart', Top);
        $('#Top_btn').bind('touchend', ClearHeroMove);
        $('#Left_btn').bind('touchstart', Left);
        $('#Left_btn').bind('touchend', ClearHeroMove);
        $('#Right_btn').bind('touchstart', Right);
        $('#Right_btn').bind('touchend', ClearHeroMove);
        $('#Bottom_btn').bind('touchstart', Bottom);
        $('#Bottom_btn').bind('touchend', ClearHeroMove);
        $('#Change_btn').bind('click', ChangeClick);
        //$('#Change_btn').bind('touchstart', Change);
        //$('#Change_btn').bind('touchend', ChangeStop);
    });

    function Top() {
        HeroMove("top");
    }
    function Left() {
        HeroMove("left");
    }
    function Right() {
        HeroMove("right");
    }
    function Bottom() {
        HeroMove("bottom");
    }
    function ChangeClick() {
        TankFire(MyTank);
    }
    function Change() {
        var intFireGo = GetintTimeFunctions("intFireGo");
        if (intFireGo && intFireGo.value) {
            return;
        }
        if (!MyTank) { return; }
        SetintTimeFunctions("intFireGo", setInterval(TankFire, Fire_Speed, MyTank));
    }
    function ChangeStop() {
        var intFireGo = GetintTimeFunctions("intFireGo");
        if (intFireGo && intFireGo.value) {
            ClearintTimeFunctions("intFireGo");
        }
    }
    function ClearHeroMove() {
        var intMoveGo = GetintTimeFunctions("intMoveGo");
        if (intMoveGo && intMoveGo.value) {
            var intICEMoveGo = GetintTimeFunctions("ICEMoveGo_" + MyTank.id);
            if (!intICEMoveGo && MyTank && MyTank.InIce) {
                MyTank.INTStep = 1;
                SetintTimeFunctions("ICEMoveGo_" + MyTank.id, setInterval(TankMove, Hero_Speed, MyTank, MyTank.direction, 1));
            }
            ClearintTimeFunctions("intMoveGo");
        }
    }
    function HeroMove(direction) {
        ClearintTimeFunctions("ICEMoveGo_" + MyTank.id);
        var intMoveGo = GetintTimeFunctions("intMoveGo");
        if (intMoveGo && intMoveGo.value) {
            return;
        }
        if (!MyTank) { return; }
        TankMove(Hero_Speed, MyTank, direction);
        SetintTimeFunctions("intMoveGo", setInterval(TankMove, Hero_Speed, MyTank, direction));
    }
</script>

</html>